# =================================================================================================#
# ROLE FUNCTION - Provision a dir storage pool located entirely within project directory in rootfs #
# =================================================================================================#

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_DIR/01 - Where's our storage directory located?"
  ansible.builtin.set_fact:
    fact_pool_target_dir: "{{ applied_lxd_role_config.role_dir }}/pools/dir/{{ input_store.name }}"

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_DIR/02 - Make LXD role_dir directory"
  ansible.builtin.file:
    path: "{{ fact_pool_target_dir }}"
    state: directory
    mode: "0755"
  become: true
  register: check_add_storage

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_DIR/02 - Build storage pool for LXD"
  # noqa: no-handler yaml[line-length]
  ansible.builtin.shell:
    cmd: "sudo -u {{ applied_lxd_role_config.target_user }} {{ applied_lxd_role_config.bin_dir }}/lxc storage create {{ input_store.name }} dir source={{ fact_pool_target_dir }}"
    executable: "{{ applied_lxd_role_config.using_shell }}"
  changed_when: false
  when: ( check_add_storage.changed )
