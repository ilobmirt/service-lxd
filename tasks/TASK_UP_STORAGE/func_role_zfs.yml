# =================================================================================================#
# ROLE FUNCTION - Provision a ZFS storage pool located entirely within project directory           #
# =================================================================================================#

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/01 - Where's our storage loop device located?"
  ansible.builtin.set_fact:
    fact_pool_target_location: "{{ applied_lxd_role_config.role_dir }}/pools/zfs/{{ input_store.name }}.img"
    fact_mount_target_location: "{{ applied_lxd_role_config.role_dir }}/mounts/zfs/{{ input_store.name }}"

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/02 - Set aside directory targets"
  ansible.builtin.file:
    path: "{{ current_path }}"
    state: directory
    mode: "0755"
  become: true
  with_items:
    - "{{ applied_lxd_role_config.role_dir }}/pools/zfs"
    - "{{ fact_mount_target_location }}"
  loop_control:
    loop_var: current_path

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/03 - Make LXD role_zfs loop device"
  ansible.builtin.copy:
    content: ""
    dest: "{{ fact_pool_target_location }}"
    force: false
    mode: "0755"
  become: true
  register: touch_zfs_loop_device

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/04 - Allocate storage for loop device"
  # noqa: no-handler
  ansible.builtin.shell:
    cmd: "truncate --size={{ input_store.size | default('1G') }} {{ fact_pool_target_location }}"
    executable: "{{ applied_lxd_role_config.using_shell }}"
  become: true
  changed_when: false
  when: ( touch_zfs_loop_device.changed )

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/05a - init zfs loop device - pool"
# noqa: no-handler
  ansible.builtin.shell:
    cmd: "zpool create -f -m legacy {{ input_store.name }} {{ fact_pool_target_location }}"
    executable: "{{ applied_lxd_role_config.using_shell }}"
  become: true
  changed_when: false
  when: ( touch_zfs_loop_device.changed )

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/05b - init zfs loop device - file system"
  community.general.zfs:
    name: "{{ input_store.name }}/fsmain"
    state: present
  become: true
  when: ( touch_zfs_loop_device.changed )

- name: "LXD_SERVICE/TASK_INIT/FUNC_ROLE_ZFS/06 - We mount our loop device"
  ansible.posix.mount:
    src: "{{ input_store.name }}/fsmain"
    path: "{{ fact_mount_target_location }}"
    opts: loop
    fstype: zfs
    state: mounted
  become: true
